<?xml version="1.0" encoding="UTF-8"?>
<!DOCTYPE mapper
   PUBLIC "-//mybatis.org//DTD Mapper 3.0//EN"
   "http://mybatis.org/dtd/mybatis-3-mapper.dtd" >

<mapper namespace="ferp.dao.B1_Dao">
	
	<!-- 본사:지난달전체매장매출총액 -->
	<select id="lastmonthAllSales" resultType="int">
		SELECT nvl(sum(payprice),0) allfrsales
		FROM orders
		WHERE state='완료'
		AND to_char(orderdate, 'YYYY/MM')=to_char(add_months(SYSDATE, -1),'YYYY/MM')
	</select>
	
	<!-- 본사:매장별매출 전체조회 -->
	<select id="SalesByStoreList" parameterType="orders" resultType="orders">
		SELECT frname, s.frreginum, frtel, frRepname, ename, nvl(frsalesum, 0) frsales, nvl(mtotal, 0) frpurchase
		FROM store s, emp e, 
			( SELECT frreginum, sum(payprice) frsalesum
			  FROM orders
			  WHERE state='완료'
			  AND TRUNC(orderdate,'month') BETWEEN to_date(#{frSchOrderdt,jdbcType=VARCHAR}, 'YYYY-MM') AND to_date(#{toSchOrderdt,jdbcType=VARCHAR}, 'YYYY-MM')
			  GROUP BY frreginum ) ord,
			( SELECT DEMANDER, sum(mcnt*price) mtotal
			  FROM PRODUCT prd, (SELECT DEMANDER, PRODUCTNUM,  sum(amount) mcnt
								FROM PRODORDER d
							  	WHERE PAYMENTSTATE='완료'
								AND TRUNC(orderdate,'month') BETWEEN to_date(#{frSchOrderdt,jdbcType=VARCHAR}, 'YYYY-MM') AND to_date(#{toSchOrderdt,jdbcType=VARCHAR}, 'YYYY-MM')
								GROUP BY PRODUCTNUM, DEMANDER) prdord 
			  WHERE prd.PRODUCTNUM=prdord.PRODUCTNUM
			  GROUP BY DEMANDER) fprdord   
		WHERE ord.frreginum(+)=s.frreginum AND s.empnum=e.empnum AND s.frreginum=fprdord.DEMANDER(+)
		and s.FRREGINUM!='9999999999'
		<if test="frname!=null and !frname.equals('')">
		AND frname LIKE '%'||#{frname}||'%'
		</if>
		<if test="frRepname!=null and !frRepname.equals('')">
		AND frRepname LIKE '%'||#{frRepname}||'%'
		</if>
		<if test="ename!=null and !ename.equals('')">
		AND ename LIKE '%'||#{ename}||'%'
		</if>
		ORDER BY frname
	</select>
	
	
	<!-- 본사:매장정보상세조회 -->
	<select id="StoreDetailInfo" parameterType="String" resultType="orders">
		SELECT frname, s.frreginum, TO_char(FROPEN,'YYYY.MM.DD') AS fropen, 
		fraddress, frtel, frrepname, ename
		FROM store s, emp e
		WHERE s.empnum=e.empnum
		AND frRegiNum=#{frRegiNum}
	</select>
	
	<!-- 본사:매장정보상세조회-매매액 -->
	<select id="DetailSalesList" parameterType="orders" resultType="orders">		
		SELECT o.orderdate, nvl(frsales,0) frsales, nvl(frpurchase,0) frpurchase,  nvl(frsales-frpurchase,0) profit
		FROM (  SELECT orderdate, nvl(sum(mcnt*price),0) frpurchase
				FROM PRODUCT p ,(SELECT to_char(orderdate, 'YYYY.MM') orderdate, PRODUCTNUM, nvl(sum(amount),0) mcnt
								FROM PRODORDER
								WHERE DEMANDER=#{frRegiNum, jdbcType=VARCHAR, index=1}
								AND PAYMENTSTATE='완료'
								GROUP BY PRODUCTNUM, to_char(orderdate, 'YYYY.MM'))po
				WHERE p.PRODUCTNUM=po.productnum
				GROUP BY orderdate ) po,
			(	SELECT to_char(orderdate,'YYYY.MM') orderdate, nvl(sum(payprice),0) frsales
				FROM ORDERS o
				where state='완료'
				AND frreginum=#{frRegiNum, jdbcType=VARCHAR, index=1}
				GROUP BY to_char(orderdate,'YYYY.MM'))o
		WHERE po.orderdate(+)=o.orderdate
		AND to_date(o.orderdate,'YYYY-MM') BETWEEN to_date(#{frSchOrderdt,jdbcType=VARCHAR}, 'YYYY-MM') AND to_date(#{toSchOrderdt,jdbcType=VARCHAR}, 'YYYY-MM')
		ORDER BY o.orderdate desc
	</select>
	
	<!-- 본사:매장정보상세조회-메뉴 -->
	<select id="DetailMenuList" parameterType="orders" resultType="orders">			
		SELECT MENUNAME, price, nvl(mcnt,0) mcnt,  nvl(price*mcnt,0) msales 
		FROM menu m, (SELECT menunum, sum(amount) mcnt
					FROM orders
					WHERE FRREGINUM=#{frRegiNum, jdbcType=VARCHAR, index=1}
					AND state='완료'
					AND TRUNC(orderdate,'month') BETWEEN to_date(#{frSchOrderdt,jdbcType=VARCHAR}, 'YYYY-MM') AND to_date(#{toSchOrderdt,jdbcType=VARCHAR}, 'YYYY-MM')
					group BY menunum) o,
					(SELECT menunum
					FROM ONSALE
					WHERE FRREGINUM=#{frRegiNum, jdbcType=VARCHAR, index=1}) os
		WHERE m.menunum=o.menunum(+) AND os.menunum=m.menunum
		ORDER BY mcnt desc, msales desc
	</select>

</mapper>